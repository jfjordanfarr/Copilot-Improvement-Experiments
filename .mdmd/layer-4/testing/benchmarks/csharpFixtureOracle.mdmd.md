# CSharp Fixture Oracle

## Metadata
- Layer: 4
- Implementation ID: IMP-541
- Code Path: [`packages/shared/src/testing/fixtureOracles/csharpFixtureOracle.ts`](../../../../packages/shared/src/testing/fixtureOracles/csharpFixtureOracle.ts)
- Exports: CSharpOracleEdgeRelation, CSharpOracleProvenance, CSharpOracleEdge, CSharpOracleEdgeRecord, CSharpFixtureOracleOptions, CSharpOracleOverrideEntry, CSharpOracleOverrideConfig, CSharpOracleSegmentPartition, CSharpOracleMergeResult, generateCSharpFixtureGraph, partitionCSharpOracleSegments, mergeCSharpOracleEdges, serializeCSharpOracleEdges

## Purpose
Deliver deterministic dependency graphs for C# benchmark fixtures by combining static Roslyn analysis with manual override reconciliation.
- Mirror the existing oracle contract so regeneration tooling can call `--lang csharp` without bespoke adapters.
- Preserve manual edges for Web Forms designer files while still surfacing drift through review artefacts.
- Produce provenance-tagged edges that the AST accuracy suite and telemetry can diff against curated expectations.

## Public Symbols

### CSharpOracleEdgeRelation
Enumerates supported relationship kinds (`"imports"`, `"uses"`) emitted by the oracle so downstream tooling can distinguish namespace directives from concrete type usage.

### CSharpOracleEdge
Canonical edge tuple containing fixture-relative `source`, `target`, `relation`, and `provenance` attributes aligned with benchmark expectations.

### CSharpOracleProvenance
Captures how each edge was discovered (`"using-directive"`, `"type-usage"`, or `"manual-override"`) to explain regeneration output.

### CSharpFixtureOracleOptions
Configuration payload accepted by the oracle, including fixture root and optional include/exclude filters to constrain Roslyn analysis.

### CSharpOracleOverrideConfig
Structure describing manual override entries loaded from `oracle.overrides.json`, enabling the oracle to match designer-driven dependencies.

### generateCSharpFixtureGraph
Entry point that indexes `.cs` files, builds a type index, disambiguates symbol usage, and emits ordered `CSharpOracleEdge` records.

### partitionCSharpOracleSegments
Separates autogenerated edges from manual overrides, identifying unmatched overrides that require author review.

### mergeCSharpOracleEdges
Combines oracle output with manual overrides, deduplicates records, and reports missing overrides for the regeneration CLI.

### serializeCSharpOracleEdges
Normalises merged edges into deterministic JSON suitable for committing as fixture expectations.

## Collaborators
- [`scripts/fixture-tools/regenerate-benchmarks.ts`](../../../../scripts/fixture-tools/regenerate-benchmarks.ts) orchestrates CLI invocations that call the C# oracle during `npm run fixtures:regenerate -- --lang csharp` runs.
- [`tests/integration/benchmarks/fixtures/csharp/`](../../../../tests/integration/benchmarks/fixtures/csharp/) stores curated expectations and override manifests validated by the oracle.
- [`packages/shared/src/inference/fallbackInference.ts`](../../../../packages/shared/src/inference/fallbackInference.ts) consumes oracle output to cross-check C# fallback heuristics.

## Linked Components
- [COMP-007 Diagnostics Benchmarking](../../../layer-3/benchmark-telemetry-pipeline.mdmd.md#comp007-diagnostics-benchmarking)
- [COMP-013 Polyglot Fixture Oracles](../../../layer-3/polyglot-oracles-and-sampling.mdmd.md#comp-013-polyglot-fixture-oracles)

## Evidence
- [`packages/shared/src/testing/fixtureOracles/csharpFixtureOracle.test.ts`](../../../../packages/shared/src/testing/fixtureOracles/csharpFixtureOracle.test.ts) validates type indexing, Web Forms override handling, and JSON serialization.
- Regeneration workflow `npm run fixtures:regenerate -- --lang csharp` refreshes both `csharp-basic` and `csharp-webforms` fixtures and stages diff artefacts under `AI-Agent-Workspace/tmp/fixture-regeneration/`.
- Latest AST accuracy benchmark run records C# fixtures with updated precision/recall metrics, confirming parity between oracle output and curated expectations.

## Operational Notes
- Designer-generated `.designer.cs` files define partial classes that must be coalesced with code-behind files; the oracle resolves these through the type index to avoid duplicate edges.
- Built-in framework namespaces (for example, `System.*`) are filtered so fixtures track only workspace-relative dependencies.
- Manual overrides remain necessary for Web Forms resources (`oracle.overrides.json`), and regeneration reports any overrides that drift out of sync with Roslyn analysis.
