# Python Fixture Oracle

## Metadata
- Layer: 4
- Implementation ID: IMP-510
- Code Path: [`packages/shared/src/testing/fixtureOracles/pythonFixtureOracle.ts`](../../../../packages/shared/src/testing/fixtureOracles/pythonFixtureOracle.ts)
- Exports: PythonOracleEdgeRelation, PythonOracleEdge, PythonOracleProvenance, PythonFixtureOracleOptions, PythonOracleOverrideEntry, PythonOracleOverrideConfig, PythonOracleEdgeRecord, PythonOracleSegmentPartition, PythonOracleMergeResult, partitionPythonOracleSegments, generatePythonFixtureGraph, mergePythonOracleEdges, serializePythonOracleEdges

## Purpose
Deliver a compiler-backed source of truth for Python benchmark fixtures without bundling interpreters into the extension runtime.
- Invoke the workspace's configured Python interpreter (virtualenv, Poetry, pipenv, or system) to analyse import graphs using standard library tooling.
- Produce deterministic JSON edge sets that match ripple semantics so inference accuracy benchmarks can detect regressions.
- Respect hand-authored overrides for cross-runtime relationships while keeping compiler-derived edges reviewable via regeneration diffs.

## Public Symbols

### PythonOracleEdgeRelation
Defines the supported relationship kinds (for example, `"imports"`, `"uses"`) emitted by the Python oracle so downstream tooling can reason about dependency classes without re-parsing raw module graphs.

### PythonOracleEdge
Structured representation of an oracle edge containing fixture-relative `source`, `target`, and `relation` values aligned with benchmark expectations.

### PythonOracleProvenance
Annotates each edge with provenance hints (`"module-import"`, `"runtime-import"`, `"type-hint"`) allowing regeneration tooling to surface why a dependency was captured and whether it may be safely overridden.

### PythonFixtureOracleOptions
Configuration payload accepted by the oracle, including interpreter path, entry-point module, inclusion filters, and environment variables to honour when spawning the Python process.

### PythonOracleOverrideEntry
Manual edge descriptor permitting fixture authors to declare relationships the oracle cannot derive (for example, dynamic imports resolved at runtime) without losing automation during regeneration.

### PythonOracleOverrideConfig
Collection of override entries loaded from `oracle.overrides.json`, enabling the regeneration CLI to match, merge, or warn on manual expectations that no longer apply.

### PythonOracleEdgeRecord
Normalised JSON-ready edge tuple used when writing oracle artefacts and diff summaries; keeps `source`, `target`, and `relation` stable across language implementations.

### PythonOracleSegmentPartition
Helper structure returned by `partitionPythonOracleSegments` exposing the separation between autogenerated edges, matched overrides, and overrides that no longer appear in oracle output.

### PythonOracleMergeResult
Aggregate view returned by `mergePythonOracleEdges` that combines deduplicated edge records, manual override matches, and the list of missing overrides for reviewer follow-up.

### partitionPythonOracleSegments
Partitions raw oracle edges against the supplied override config so downstream tooling can warn when manual edges drift or go unused.

### generatePythonFixtureGraph
Primary entry point that shells out to the configured interpreter, executes the helper module responsible for walking imports via `modulefinder`/`importlib`, and returns an ordered list of `PythonOracleEdge` records.

### mergePythonOracleEdges
Combines oracle-derived edges with manual overrides, deduplicates by `(source,target,relation)`, and emits statistics about unmatched overrides so reviewers know when curated expectations need updates.

### serializePythonOracleEdges
Normalises merged edges into canonical JSON by sorting, de-duplicating, and redacting environment-specific metadata prior to writing benchmark fixtures.

## Collaborators
- [`scripts/fixture-tools/regenerate-ts-benchmarks.ts`](../../../../scripts/fixture-tools/regenerate-ts-benchmarks.ts) orchestrates interpreter detection, oracle execution, and diff artefact staging for both TypeScript and Python fixtures.
- [`packages/shared/src/testing/fixtureOracles/typeScriptFixtureOracle.ts`](../../../../packages/shared/src/testing/fixtureOracles/typeScriptFixtureOracle.ts) offers the reference API this module mirrors so regeneration tooling can stay language-agnostic.
- [`tests/integration/benchmarks/fixtures/python/requests/`](../../../../tests/integration/benchmarks/fixtures/python/requests/) houses the first fixture regenerated by the oracle, providing integration coverage.

## Linked Components
- [COMP-007 Diagnostics Benchmarking](../../../layer-3/benchmark-telemetry-pipeline.mdmd.md#comp007-diagnostics-benchmarking)

## Evidence
- Unit suite [`pythonFixtureOracle.test.ts`](/packages/shared/src/testing/fixtureOracles/pythonFixtureOracle.test.ts) exercises override handling, merge determinism, and serialization guarantees.
- Regeneration CLI invocation `npm run fixtures:regenerate -- --lang python` refreshes Python fixtures (basics, pipeline, requests) and writes review diffs under `AI-Agent-Workspace/tmp/fixture-regeneration/`.
- Latest AST benchmark run shows Python fixtures at 1.00 precision/recall, confirming oracle output and fallback heuristics stay aligned with curated expectations.

## Operational Notes
- Interpreter resolution must respect workspace-local virtual environments before falling back to `python`/`py` on PATH to avoid contaminating global installations.
- Subprocess invocations should stream JSON through stdout to avoid temp files and guarantee deterministic ordering across platforms.
- Regeneration should detect missing interpreters and emit actionable warnings while preserving existing expectations so `safe:commit` remains stable.
