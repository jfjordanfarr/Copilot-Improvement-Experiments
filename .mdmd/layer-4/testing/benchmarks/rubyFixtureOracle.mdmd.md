# Ruby Fixture Oracle

## Metadata
- Layer: 4
- Implementation ID: IMP-524
- Code Path: [`packages/shared/src/testing/fixtureOracles/rubyFixtureOracle.ts`](../../../../packages/shared/src/testing/fixtureOracles/rubyFixtureOracle.ts)
- Exports: RubyOracleEdgeRelation, RubyOracleEdge, RubyOracleProvenance, RubyFixtureOracleOptions, RubyOracleOverrideEntry, RubyOracleOverrideConfig, RubyOracleEdgeRecord, RubyOracleSegmentPartition, RubyOracleMergeResult, generateRubyFixtureGraph, partitionRubyOracleSegments, mergeRubyOracleEdges, serializeRubyOracleEdges

## Purpose
Produce deterministic dependency graphs for Ruby benchmarks by parsing `require_relative` declarations, normalising file paths, and preserving manual overrides for metaprogramming-heavy code.
- Mirror the shared oracle contract so regeneration tooling can invoke `--lang ruby` without bespoke scaffolding.
- Annotate edges with provenance (static require, manual override) to inform reviewers and telemetry pipelines.
- Enable AST accuracy benchmarks to validate fallback heuristics against actual interpreter output before LLM sampling introduces suggestions, with future work planned to incorporate interpreter traces when available.

## Public Symbols
### RubyOracleEdgeRelation
Enumerates the "requires" relationship emitted by the oracle so downstream tooling can trace file-level load dependencies.

### RubyOracleEdge
Fixture-relative edge tuple that aligns with ripple expectations for documentation and diagnostics.

### RubyOracleProvenance
Records how each edge was discovered (`"require"`, `"manual-override"`) to maintain auditability.

### RubyFixtureOracleOptions
Options payload containing the fixture root plus optional include/exclude globs that scope which `.rb` files the oracle evaluates.

### RubyOracleOverrideEntry
Manual descriptor for edges surfaced via metaprogramming or runtime DSLs that need to persist across regeneration runs.

### RubyOracleOverrideConfig
Override manifest loader enabling regeneration tooling to reconcile manual expectations with oracle-derived edges.

### RubyOracleEdgeRecord
Canonical JSON tuple persisted with deterministic ordering for benchmark comparisons.

### RubyOracleSegmentPartition
Separates autogenerated edges, satisfied overrides, and missing overrides for reviewer attention.

### RubyOracleMergeResult
Aggregated merge results containing deduplicated edges, unresolved overrides, and provenance statistics.

### generateRubyFixtureGraph
Parses source files for `require_relative` statements, resolves relative paths, and returns ordered `RubyOracleEdge` records.

### partitionRubyOracleSegments
Matches oracle output with manual overrides, surfacing stale expectations.

### mergeRubyOracleEdges
Combines oracle edges and overrides, deduplicating while capturing provenance stats for diff reports.

### serializeRubyOracleEdges
Normalises merged edges into canonical JSON with stable ordering and metadata redaction suitable for fixtures.

## Collaborators
- [`scripts/fixture-tools/regenerate-benchmarks.ts`](../../../../scripts/fixture-tools/regenerate-benchmarks.ts) (post-refactor) drives oracle execution when `--lang ruby` is requested and emits review artefacts.
- [`tests/integration/benchmarks/fixtures/ruby/`](../../../../tests/integration/benchmarks/fixtures/ruby/) stores curated expectations validated by the AST accuracy suite.
- [`packages/shared/src/inference/fallbackInference.ts`](../../../../packages/shared/src/inference/fallbackInference.ts) will compare Ruby heuristics against oracle truth to ensure deterministic coverage before sampling.

## Linked Components
- [COMP-007 Diagnostics Benchmarking](../../../layer-3/benchmark-telemetry-pipeline.mdmd.md#comp007-diagnostics-benchmarking)
- [COMP-013 Polyglot Fixture Oracles](../../../layer-3/polyglot-oracles-and-sampling.mdmd.md#comp-013-polyglot-fixture-oracles)

## Evidence
- [`packages/shared/src/testing/fixtureOracles/rubyFixtureOracle.test.ts`](../../../../packages/shared/src/testing/fixtureOracles/rubyFixtureOracle.test.ts) validates require parsing, override handling, and serialization stability across representative fixtures.
- `npm run test:benchmarks -- --suite ast` will report Ruby precision/recall metrics and fail if expectations drift from oracle truth.
- Telemetry snapshots in `reports/benchmarks/ast/ast-accuracy.json` will log Ruby coverage and highlight missing toolchain prerequisites.
