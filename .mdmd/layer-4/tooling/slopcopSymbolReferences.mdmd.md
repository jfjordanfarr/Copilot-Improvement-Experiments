title: "SlopCop Symbol Reference Audit"
# SlopCop Symbol Reference Audit (Layer 4)

## Source Mapping
- Markdown heading analyzer + slugger: [`packages/shared/src/tooling/symbolReferences.ts`](/packages/shared/src/tooling/symbolReferences.ts)
- Shared markdown helpers: [`packages/shared/src/tooling/markdownShared.ts`](/packages/shared/src/tooling/markdownShared.ts)
- Vendored GitHub slugger: [`packages/shared/src/tooling/githubSlugger.ts`](/packages/shared/src/tooling/githubSlugger.ts), [`packages/shared/src/tooling/githubSluggerRegex.ts`](/packages/shared/src/tooling/githubSluggerRegex.ts), [`packages/shared/src/tooling/githubSlugger.test.ts`](/packages/shared/src/tooling/githubSlugger.test.ts)
- Unit coverage: [`packages/shared/src/tooling/symbolReferences.test.ts`](/packages/shared/src/tooling/symbolReferences.test.ts)
- CLI harness + integration smoke: [`scripts/slopcop/check-symbols.ts`](/scripts/slopcop/check-symbols.ts), [`packages/shared/src/tooling/slopcopSymbolsCli.test.ts`](/packages/shared/src/tooling/slopcopSymbolsCli.test.ts)
- Fixture workspace: [`tests/integration/fixtures/slopcop-symbols`](../../../tests/integration/fixtures/slopcop-symbols)

## Purpose
Audit Markdown/MDMD heading anchors so SlopCop can report missing or ambiguous symbols before code review. This S0 pass keeps documentation navigable, unlocks doc↔code parity in later phases, and vendors the exact GitHub/VS Code slugging behaviour we need for consistent anchor IDs.

## Design Goals
- Reuse GitHub's slug algorithm verbatim to match VS Code preview, avoiding mismatched anchors (especially for Unicode).
- Provide diagnostics with actionable context (file, line, slug, suggested fix) and deterministic severities (`warn` for duplicates, `error` for missing anchors by default).
- Handle both inline anchor links (for example, inline markdown targeting `#foo`) and reference-style anchors that pair a link label with a later definition pointing at the same slug, ignoring links that point outside the workspace or match configured ignore patterns.
- Keep the implementation ergonomic for future phases: heading extraction is pure, memoizable, and ready to feed graph snapshot ingestion.

## Behaviour (Phase S0)
1. Walk all Markdown/MDMD files selected by `slopcop.config.json`.
2. Extract headings while skipping fenced code blocks, handling ATX (`#`) and Setext (`===`/`---`) styles.
3. Slugify headings with the vendored GitHub algorithm, tracking duplicate indices (`foo`, `foo-1`, ...).
4. Parse anchor references (inline + reference definitions) and resolve cross-document links (`doc.md#slug`) relative to the workspace.
5. Emit diagnostics:
	- `duplicate-heading` (default severity `warn`) when a heading produces a suffixed slug (`-1`, `-2`, ...).
	- `missing-anchor` (default severity `error`) when a local or cross-file anchor references a slug that is absent in the target document.
6. Honour `symbols.ignoreTargets` regexes for slug suppression and `symbols.includeGlobs` / `symbols.ignoreGlobs` for file selection.
7. Report results via `scripts/slopcop/check-symbols.ts` with human and JSON output, deterministic exit codes, and fixture-backed regression coverage.

## Configuration
- `slopcop.config.json` gains a `symbols` block with:
	- `enabled` (opt-in flag; CLI exits early when false or omitted).
	- `includeGlobs` / `ignoreGlobs` for file discovery.
	- `ignoreTargets` (regex array) to silence known slugs (e.g., autogenerated ToC anchors).
	- `duplicateHeadingSeverity` and `missingAnchorSeverity` (`off` | `warn` | `error`).
- Repository default keeps the feature disabled until we tame duplicate headings in MDMD; the integration fixture enables it to exercise the CLI.

## Evidence
- **Unit tests**: assert duplicate detection, missing anchor reporting, and ignore/severity overrides (`symbolReferences.test.ts`).
- **GitHub slugger parity**: vendored tests confirm casing, punctuation, emoji, and duplicate tracking match upstream (`githubSlugger.test.ts`).
- **CLI smoke**: executes against a curated workspace with failing → passing repair flow (`slopcopSymbolsCli.test.ts`).
- **Fixture workspace**: `tests/integration/fixtures/slopcop-symbols` includes Markdown docs with deliberate gaps plus a local `slopcop.config.json` that enables symbol lint.

## Next Steps
- Feed heading extraction into `graph:snapshot` so S1 can compare docs to knowledge-graph exports.
- Expand configuration to scope linting to MDMD tiers (e.g., Layer‑4 only) once orphan rules land.
- Surface diagnostics through the VS Code extension so symbol lint appears alongside existing SlopCop checks.
